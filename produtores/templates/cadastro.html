{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="bg-white rounded-5 p-4 p-md-5 mb-5 shadow-lg">
    <div class="text-center mb-5">
        <h1 class="display-5 fw-extrabold text-uppercase" style="color: #4fa34f;">Cadastro de Produtor</h1>
        <p class="text-muted">Junte-se à nossa rede de sustentabilidade</p>
    </div>

    <form method="POST" id="formCadastro" novalidate>
        {% csrf_token %}
        <div class="row g-4">
            <div class="col-md-6">
                <label class="form-label small fw-bold text-uppercase">Nome do Responsável <span class="text-danger">*</span></label>
                <input type="text" name="full_name" id="full_name" class="form-control border-0 bg-light p-3 rounded-3" required>
                <div class="invalid-feedback">O nome é obrigatório.</div>
            </div>

            <div class="col-md-6">
                <label class="form-label small fw-bold text-uppercase">CPF <span class="text-danger">*</span></label>
                <input type="text" id="cpf" name="cpf" class="form-control border-0 bg-light p-3 rounded-3" placeholder="000.000.000-00" required>
                <div class="invalid-feedback">CPF inválido.</div>
            </div>

            <div class="col-md-4">
                <label class="form-label small fw-bold text-uppercase">CEP <span class="text-danger">*</span></label>
                <input type="text" id="cep" name="cep" class="form-control border-0 bg-light p-3 rounded-3" placeholder="00000-000" required>
            </div>

            <div class="col-md-8">
                <label class="form-label small fw-bold text-uppercase">Logradouro e Número <span class="text-danger">*</span></label>
                <input type="text" id="adress" name="adress" class="form-control border-0 bg-light p-3 rounded-3" required>
            </div>

            <div class="col-md-5">
                <label class="form-label small fw-bold text-uppercase">Cidade <span class="text-danger">*</span></label>
                <input type="text" id="city" name="city" class="form-control border-0 bg-light p-3 rounded-3" required>
            </div>

            <div class="col-md-2">
                <label class="form-label small fw-bold text-uppercase">Estado <span class="text-danger">*</span></label>
                <input type="text" id="state" name="state" class="form-control border-0 bg-light p-3 rounded-3" placeholder="Ex: PA" maxlength="2" required>
            </div>

            <div class="col-md-5">
                <label class="form-label small fw-bold text-uppercase">Telefone <span class="text-danger">*</span></label>
                <input type="tel" id="phone_number" name="phone_number" class="form-control border-0 bg-light p-3 rounded-3" required>
            </div>

            <div class="col-md-6">
                <label class="form-label small fw-bold text-uppercase">Nome da Empresa (Opcional)</label>
                <input type="text" name="employment_name" class="form-control border-0 bg-light p-3 rounded-3">
            </div>

            <div class="col-md-6">
                <label class="form-label small fw-bold text-uppercase">CNPJ (Opcional)</label>
                <input type="text" id="cnpj" name="cnpj" class="form-control border-0 bg-light p-3 rounded-3">
            </div>

            <div class="col-md-12">
                <label class="form-label small fw-bold text-uppercase">Email de Acesso <span class="text-danger">*</span></label>
                <input type="email" name="email_adress" id="email" class="form-control border-0 bg-light p-3 rounded-3" required>
            </div>

            <div class="col-md-6">
                <label class="form-label small fw-bold text-uppercase">Senha <span class="text-danger">*</span></label>
                <input type="password" name="password" id="password" class="form-control border-0 bg-light p-3 rounded-3" required minlength="8">
            </div>

            <div class="col-md-6">
                <label class="form-label small fw-bold text-uppercase">Confirmar Senha <span class="text-danger">*</span></label>
                <input type="password" id="confirmar_senha" class="form-control border-0 bg-light p-3 rounded-3" required>
                <div id="senhaFeedback" class="invalid-feedback">As senhas não coincidem.</div>
            </div>

            <div class="col-12 mt-5">
                <div class="row align-items-center">
                    <div class="col-md-6 text-center text-md-start">
                        <img src="{% static 'images/fazendeiro-cadastro-sf.png' %}" class="img-fluid" style="max-height: 250px;" alt="Cadastro">
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <button type="submit" onclick="validarCadastro(event)" class="btn btn-custom px-5 py-3 shadow">FINALIZAR CADASTRO</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</section>

<style>
    .fw-extrabold { font-weight: 800; }
    .form-control:focus {
        box-shadow: 0 0 0 0.25rem rgba(91, 183, 91, 0.25);
        border: 1px solid #5bb75b;
        background-color: #fff !important;
    }
    .form-control.is-invalid {
        border: 2px solid #dc3545 !important;
        background-color: #fff8f8 !important;
    }
</style>

<script>
    document.getElementById('cep').addEventListener('blur', function() {
        const cep = this.value.replace(/\D/g, '');
        if (cep.length === 8) {
            fetch(`https://viacep.com.br/ws/${cep}/json/`)
                .then(res => res.json())
                .then(data => {
                    if (!data.erro) {
                        document.getElementById('adress').value = data.logradouro;
                        document.getElementById('city').value = data.localidade;
                        document.getElementById('state').value = data.uf;
                    }
                });
        }
    });

    function isValidCPF(cpf) {
        cpf = cpf.replace(/\D/g, '');
        if (cpf.length !== 11 || !!cpf.match(/(\d)\1{10}/)) return false;

        let soma = 0;
        let resto;

        for (let i = 1; i <= 9; i++) soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
        resto = (soma * 10) % 11;
        if ((resto === 10) || (resto === 11)) resto = 0;
        if (resto !== parseInt(cpf.substring(9, 10))) return false;

        soma = 0;
        for (let i = 1; i <= 10; i++) soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
        resto = (soma * 10) % 11;
        if ((resto === 10) || (resto === 11)) resto = 0;
        if (resto !== parseInt(cpf.substring(10, 11))) return false;

        return true;
    }

    const mask = (id, fn) => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', e => e.target.value = fn(e.target.value));
    };
    mask('cpf', v => v.replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4"));
    mask('phone_number', v => v.replace(/\D/g, '').replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3"));

    function validarCadastro(event) {
        const campos = ['full_name', 'cpf', 'cep', 'adress', 'city', 'state', 'phone_number', 'email', 'password', 'confirmar_senha'];
        let valido = true;

        campos.forEach(id => {
            const el = document.getElementById(id);
            if (!el.value.trim()) {
                el.classList.add('is-invalid');
                valido = false;
            } else {
                el.classList.remove('is-invalid');
            }
        });

        const cpfInput = document.getElementById('cpf');
        if (!isValidCPF(cpfInput.value)) {
            cpfInput.classList.add('is-invalid');
            valido = false;
        }

        const pass = document.getElementById('password');
        const confirm = document.getElementById('confirmar_senha');
        if (pass.value !== confirm.value || !confirm.value) {
            confirm.classList.add('is-invalid');
            valido = false;
        }

        if (!valido) event.preventDefault();
    }
</script>
{% endblock %}